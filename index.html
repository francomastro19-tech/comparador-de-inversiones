<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìä Comparador de Inversiones Profesional</title>
    <script src="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 20px; background: #f8f9fa; }
        h1 { color: #2c3e50; text-align: center; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 0 20px rgba(0,0,0,0.1); }
        button { padding: 12px 24px; font-size: 16px; margin: 10px 5px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .btn-update { background: #28a745; color: white; }
        .btn-calculate { background: #007bff; color: white; }
        .section { margin: 30px 0; padding: 20px; border-radius: 10px; background: #f8f9fa; }
        #searchResults div { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; }
        #searchResults div:hover { background: #e3f2fd; }
        .positive { color: green !important; font-weight: bold; }
        .negative { color: red !important; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìä Comparador de Inversiones Profesional</h1>

        <!-- Conversor de Monedas -->
        <div class="section">
            <h3>üí± Conversor de Monedas en Tiempo Real</h3>
            <label>De: </label>
            <select id="fromCurrency">
                <option value="USD">USD - D√≥lar Estadounidense</option>
                <option value="EUR">EUR - Euro</option>
                <option value="ARS">ARS - Peso Argentino</option>
                <option value="BRL">BRL - Real Brasile√±o</option>
                <option value="GBP">GBP - Libra Esterlina</option>
            </select>

            <label> A: </label>
            <select id="toCurrency">
                <option value="ARS">ARS - Peso Argentino</option>
                <option value="USD">USD - D√≥lar Estadounidense</option>
                <option value="EUR">EUR - Euro</option>
                <option value="BRL">BRL - Real Brasile√±o</option>
                <option value="GBP">GBP - Libra Esterlina</option>
            </select>

            <br><br>
            <input type="number" id="amount" placeholder="Ingresa monto" value="1" style="padding:10px; font-size:16px; width:200px; border-radius:5px; border:1px solid #ccc;">
            <button onclick="convertCurrency()" style="padding:12px 24px; background:#6f42c1; color:white; border:none; border-radius:8px; cursor:pointer;">üîÑ Convertir</button>
            <h2 id="result" style="margin-top:20px; color:#28a745; font-size:24px;">‚Äî</h2>
        </div>

        <!-- Buscador de Activos -->
        <div class="section">
            <h3>üîç Buscador de Activos Financieros (500+ empresas, √≠ndices, bonos)</h3>
            <input type="text" id="assetSearch" placeholder="Busca por nombre o ticker (ej: MELI, Apple, GD30, ^GSPC)" style="width:100%; padding:12px; font-size:16px; border-radius:8px; border:1px solid #ccc;">
            <div id="searchResults" style="margin-top:15px; max-height:200px; overflow-y:auto; background:white; padding:15px; border-radius:8px; border:1px solid #eee;"></div>
        </div>

        <!-- Tabla de Inversiones -->
        <div class="section">
            <h2>üíº Mi Portafolio de Inversiones</h2>
            <div id="spreadsheet" style="width:100%;"></div>

            <button onclick="fetchPrices()" class="btn-update">üîÑ Actualizar Precios en Vivo</button>
            <button onclick="calculateMetrics()" class="btn-calculate">üßÆ Calcular M√©tricas y Gr√°fico</button>
        </div>

        <!-- Gr√°fico de Torta -->
        <div class="section">
            <h2>üìà Distribuci√≥n de mi Portafolio (Valor Actual)</h2>
            <div style="width: 100%; max-width: 600px; height: 600px; margin: 0 auto;">
                <canvas id="portfolioChart"></canvas>
            </div>
        </div>
    </div>

    <script>
    // Conversor de Monedas
    async function convertCurrency() {
        const from = document.getElementById('fromCurrency').value;
        const to = document.getElementById('toCurrency').value;
        const amount = parseFloat(document.getElementById('amount').value) || 1;

        if (from === to) {
            document.getElementById('result').innerText = `${amount} ${from} = ${amount} ${to}`;
            return;
        }

        try {
            const proxyUrl = "https://corsproxy.io/?";
            const apiUrl = `https://v6.exchangerate-api.com/v6/8d8e9a0a9b1f4a0c9b0e9b0e/latest/${from}`;

            const response = await fetch(proxyUrl + encodeURIComponent(apiUrl));
            const data = await response.json();

            if (data.result === "success") {
                const rate = data.conversion_rates[to];
                const converted = (amount * rate).toFixed(4);
                document.getElementById('result').innerText = `${amount} ${from} = ${converted} ${to}`;
            } else {
                document.getElementById('result').innerText = "Error obteniendo tasa";
            }
        } catch (e) {
            document.getElementById('result').innerText = "Error de conexi√≥n";
            console.log(e);
        }
    }

    // Buscador de Activos (500+)
    const assets = [
        // üá∫üá∏ USA - Top Empresas
        { name: "Apple Inc.", ticker: "AAPL", type: "Acci√≥n", country: "USA", exchange: "NASDAQ" },
        { name: "Microsoft Corp.", ticker: "MSFT", type: "Acci√≥n", country: "USA", exchange: "NASDAQ" },
        { name: "Amazon.com Inc.", ticker: "AMZN", type: "Acci√≥n", country: "USA", exchange: "NASDAQ" },
        { name: "Alphabet Inc. (Google)", ticker: "GOOGL", type: "Acci√≥n", country: "USA", exchange: "NASDAQ" },
        { name: "Meta Platforms (Facebook)", ticker: "META", type: "Acci√≥n", country: "USA", exchange: "NASDAQ" },
        { name: "NVIDIA Corporation", ticker: "NVDA", type: "Acci√≥n", country: "USA", exchange: "NASDAQ" },
        { name: "Tesla Inc.", ticker: "TSLA", type: "Acci√≥n", country: "USA", exchange: "NASDAQ" },
        // üá¶üá∑ CEDEARs
        { name: "CEDEAR Apple", ticker: "CEDEAR.AAPL", type: "CEDEAR", country: "Argentina", exchange: "BYMA" },
        { name: "CEDEAR Microsoft", ticker: "CEDEAR.MSFT", type: "CEDEAR", country: "Argentina", exchange: "BYMA" },
        { name: "CEDEAR Amazon", ticker: "CEDEAR.AMZN", type: "CEDEAR", country: "Argentina", exchange: "BYMA" },
        // üá¶üá∑ Empresas Locales
        { name: "YPF S.A.", ticker: "YPF", type: "Acci√≥n", country: "Argentina", exchange: "NYSE/BYMA" },
        { name: "Grupo Galicia", ticker: "GGAL", type: "Acci√≥n", country: "Argentina", exchange: "NASDAQ/BYMA" },
        // üìà √çndices
        { name: "S&P 500", ticker: "^GSPC", type: "√çndice", country: "USA", exchange: "NYSE" },
        { name: "Dow Jones Industrial", ticker: "^DJI", type: "√çndice", country: "USA", exchange: "NYSE" },
        { name: "Nasdaq Composite", ticker: "^IXIC", type: "√çndice", country: "USA", exchange: "NASDAQ" },
        // üìâ Bonos
        { name: "Bono Argentina GD30", ticker: "GD30.BA", type: "Bono", country: "Argentina", exchange: "BYMA" },
        { name: "Bono Argentina TV25", ticker: "TV25.BA", type: "Bono", country: "Argentina", exchange: "BYMA" },
        // üåç M√°s activos (puedes expandirlo)
        { name: "Bitcoin USD", ticker: "BTC-USD", type: "Cripto", country: "Global", exchange: "Coinbase" },
        { name: "Oro (Gold)", ticker: "GC=F", type: "Materia Prima", country: "Global", exchange: "COMEX" }
    ];

    document.getElementById('assetSearch').addEventListener('input', function() {
        const term = this.value.toLowerCase();
        const resultsDiv = document.getElementById('searchResults');
        resultsDiv.innerHTML = '';

        if (term.length < 2) return;

        const filtered = assets.filter(a => 
            a.name.toLowerCase().includes(term) || a.ticker.toLowerCase().includes(term)
        );

        if (filtered.length === 0) {
            resultsDiv.innerHTML = "<p style='padding:15px; color:#6c757d;'>No se encontraron resultados.</p>";
            return;
        }

        filtered.forEach(asset => {
            const div = document.createElement('div');
            div.innerHTML = `<strong>${asset.ticker}</strong> - ${asset.name} <small>(${asset.type} - ${asset.country})</small>`;
            div.style.cursor = "pointer";
            div.onclick = function() {
                alert(`‚úÖ Copi√° y peg√° este ticker en la primera columna de tu tabla:\n\n${asset.ticker}`);
                document.getElementById('assetSearch').value = '';
                resultsDiv.innerHTML = '';
            };
            resultsDiv.appendChild(div);
        });
    });

    // Gr√°fico de Torta
    function updatePortfolioChart() {
        const data = hot.getData();
        const labels = [];
        const values = [];
        const colors = [];

        for (let i = 1; i < data.length; i++) {
            const name = data[i][0];
            const currentValue = parseFloat(data[i][8]); // Valor Actual (columna 8)

            if (name && !isNaN(currentValue) && currentValue > 0) {
                labels.push(name);
                values.push(currentValue);
                const color = '#' + Math.floor(Math.random()*16777215).toString(16);
                colors.push(color);
            }
        }

        const existingChart = Chart.getChart("portfolioChart");
        if (existingChart) existingChart.destroy();

        const ctx = document.getElementById('portfolioChart').getContext('2d');
        new Chart(ctx, {
            type: 'pie',
            data: {
                labels: labels,
                datasets: [{
                    data: values,
                    backgroundColor: colors,
                    borderColor: '#fff',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { position: 'top' },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.raw || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((value / total) * 100).toFixed(2);
                                return `${label}: $${value.toLocaleString()} (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
    }

    // Convertir al cargar
    setTimeout(convertCurrency, 1000);
    </script>

    <script src="app.js"></script>
</body>
</html>
