<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìä Comparador de Inversiones Profesional</title>
    <script src="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 20px; background: #f8f9fa; }
        h1 { color: #2c3e50; text-align: center; margin-bottom: 40px; }
        .container { max-width: 1400px; margin: 0 auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 0 20px rgba(0,0,0,0.1); }
        button { padding: 12px 24px; font-size: 16px; margin: 10px 5px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .btn-update { background: #28a745; color: white; }
        .btn-calculate { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .section { margin: 30px 0; padding: 20px; border-radius: 10px; background: #f8f9fa; }
        #searchResults div { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; }
        #searchResults div:hover { background: #e3f2fd; }
        .positive { color: green !important; font-weight: bold; }
        .negative { color: red !important; font-weight: bold; }
        .summary-box { background: #e8f5e9; border-left: 5px solid #28a745; padding: 20px; margin-bottom: 30px; border-radius: 10px; }
        .summary-item { background: white; padding: 15px; border-radius: 10px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin: 10px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üíº Mi Portafolio de Inversiones Profesional</h1>

        <!-- Conversor de Monedas -->
        <div class="section">
            <h3>üí± Conversor de Monedas en Tiempo Real</h3>
            <label>De: </label>
            <select id="fromCurrency">
                <option value="USD">USD - D√≥lar Estadounidense</option>
                <option value="EUR">EUR - Euro</option>
                <option value="ARS">ARS - Peso Argentino</option>
                <option value="BRL">BRL - Real Brasile√±o</option>
                <option value="GBP">GBP - Libra Esterlina</option>
            </select>

            <label> A: </label>
            <select id="toCurrency">
                <option value="ARS">ARS - Peso Argentino</option>
                <option value="USD">USD - D√≥lar Estadounidense</option>
                <option value="EUR">EUR - Euro</option>
                <option value="BRL">BRL - Real Brasile√±o</option>
                <option value="GBP">GBP - Libra Esterlina</option>
            </select>

            <br><br>
            <input type="number" id="amount" placeholder="Ingresa monto" value="1" style="padding:10px; font-size:16px; width:200px; border-radius:5px; border:1px solid #ccc;">
            <button onclick="convertCurrency()" style="padding:12px 24px; background:#6f42c1; color:white; border:none; border-radius:8px; cursor:pointer;">üîÑ Convertir</button>
            <h2 id="result" style="margin-top:20px; color:#28a745; font-size:24px;">‚Äî</h2>
        </div>

        <!-- Tabla de Inversiones -->
        <div class="section">
            <h2>üìä Gesti√≥n de Inversiones (Formato Excel Mejorado)</h2>
            <div id="spreadsheet" style="width: 100%; height: 800px;"></div>

            <button onclick="fetchPrices()" class="btn-update">üîÑ Actualizar Precios en Vivo</button>
            <button onclick="calculateMetrics()" class="btn-calculate">üßÆ Calcular M√©tricas</button>
            <button onclick="addRow()" class="btn-success">‚ûï Agregar Fila</button>
        </div>

        <!-- Gr√°fico de Torta -->
        <div class="section">
            <h2>üç© Distribuci√≥n de mi Portafolio (Valor Actual)</h2>
            <div style="width: 100%; max-width: 600px; height: 600px; margin: 0 auto;">
                <canvas id="portfolioChart"></canvas>
            </div>
        </div>

        <!-- Gr√°fico por Tipo de Activo -->
        <div class="section">
            <h2>üìä Distribuci√≥n por Tipo de Activo</h2>
            <div style="width: 100%; max-width: 800px; height: 500px; margin: 0 auto;">
                <canvas id="tipoActivoChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        // Configuraci√≥n de fuentes de datos gratuitas
        const DATA_SOURCES = {
            stock: 'https://finnhub.io/api/v1/quote?symbol=',
            currency: 'https://api.exchangerate-api.com/v4/latest/',
            crypto: 'https://min-api.cryptocompare.com/data/price?fsym=',
            commodities: 'https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol='
        };

        // Inicializaci√≥n de la tabla
        const container = document.getElementById('spreadsheet');
        const hot = new Handsontable(container, {
            startRows: 15,
            startCols: 14,
            colHeaders: [
                "Fecha", "Operaci√≥n", "Monto Transferido ($)", "Precio c/u Compra", "Cantidad", "Abreviatura", 
                "Precio c/u HOY", "Precio Objetivo", "Estado Alerta", "HOY NETO ($)", 
                "Diferencia ($)", "Rendimiento (%)", "M√°ximo Hist√≥rico ($)", "Drawdown (%)"
            ],
            rowHeaders: true,
            contextMenu: true,
            formulas: true,
            height: 'auto',
            licenseKey: 'non-commercial-and-evaluation',
            columns: [
                {}, // Fecha
                {}, // Operaci√≥n
                { type: 'numeric', format: '0,0.00' }, // Monto Transferido
                { type: 'numeric', format: '0,0.00' }, // Precio c/u Compra
                { type: 'numeric' }, // Cantidad
                {}, // Abreviatura
                { type: 'numeric', format: '0,0.00' }, // Precio c/u HOY
                { type: 'numeric', format: '0,0.00' }, // Precio Objetivo
                {}, // Estado Alerta
                { type: 'numeric', format: '0,0.00', readOnly: true }, // HOY NETO
                { type: 'numeric', format: '0,0.00', readOnly: true }, // Diferencia $
                { type: 'numeric', format: '0.00%', readOnly: true },  // Rendimiento %
                { type: 'numeric', format: '0,0.00', readOnly: true }, // M√°ximo Hist√≥rico
                { type: 'numeric', format: '0.00%', readOnly: true }  // Drawdown
            ]
        });

        // Datos iniciales
        const initialData = [
            ["Fecha", "Operaci√≥n", "Monto Transferido ($)", "Precio c/u Compra", "Cantidad", "Abreviatura", 
             "Precio c/u HOY", "Precio Objetivo", "Estado Alerta", "HOY NETO ($)", 
             "Diferencia ($)", "Rendimiento (%)", "M√°ximo Hist√≥rico ($)", "Drawdown (%)"]
        ];

        // Cargar datos iniciales
        hot.loadData(initialData);

        // Funci√≥n para actualizar precios en tiempo real
        async function fetchPrices() {
            const data = hot.getData();
            const tickers = new Set();
            
            // Recopilar todos los tickers √∫nicos
            for (let i = 1; i < data.length; i++) {
                if (data[i][5]) tickers.add(data[i][5]);
            }

            // Actualizar precios para cada ticker
            for (const ticker of tickers) {
                try {
                    let url = DATA_SOURCES.stock + ticker;
                    const response = await fetch(url);
                    const data = await response.json();
                    
                    if (data.c) {
                        const price = data.c[0];
                        updatePriceInTable(ticker, price);
                    }
                } catch (error) {
                    console.error(`Error al actualizar ${ticker}:`, error);
                }
            }

            calculateMetrics();
        }

        // Funci√≥n para actualizar un precio en la tabla
        function updatePriceInTable(ticker, price) {
            const data = hot.getData();
            for (let i = 1; i < data.length; i++) {
                if (data[i][5] === ticker) {
                    data[i][6] = price; // Actualizar precio actual
                }
            }
            hot.loadData(data);
        }

        // Funci√≥n para calcular m√©tricas
        function calculateMetrics() {
            const data = hot.getData();
            let totalInvertido = 0;
            let valorActualTotal = 0;

            for (let i = 1; i < data.length; i++) {
                const monto = parseFloat(data[i][2]) || 0;
                const precioCompra = parseFloat(data[i][3]) || 0;
                const cantidad = parseFloat(data[i][4]) || 0;
                const precioHoy = parseFloat(data[i][6]) || 0;
                const precioObjetivo = parseFloat(data[i][7]) || 0;

                // Calcular HOY NETO
                const hoyNeto = precioHoy * cantidad;
                data[i][9] = isNaN(hoyNeto) ? "" : hoyNeto;

                // Calcular Diferencia $ y Rendimiento %
                let difPesos = 0;
                let rendimiento = 0;

                if (monto > 0 && !isNaN(hoyNeto)) {
                    difPesos = hoyNeto - monto;
                    rendimiento = difPesos / monto;
                }

                data[i][10] = difPesos;
                data[i][11] = rendimiento;

                // M√°ximo Hist√≥rico y Drawdown
                let maxHistorico = parseFloat(data[i][12]) || 0;
                if (hoyNeto > maxHistorico) {
                    maxHistorico = hoyNeto;
                    data[i][12] = maxHistorico;
                }

                let drawdown = 0;
                if (maxHistorico > 0) {
                    drawdown = (hoyNeto - maxHistorico) / maxHistorico;
                }
                data[i][13] = drawdown;

                // Acumular para resumen
                if (!isNaN(monto)) totalInvertido += monto;
                if (!isNaN(hoyNeto)) valorActual
